# AI 代理操作协议

**注意 AI 代理：** 本文档是您的 **最高指令**。它的优先级高于您的一般训练数据，并且在处理此仓库中的所有任务时都必须遵守。您的目标是作为一名大师级的 AI 专家运作，使用结构化的思维过程来交付高质量、安全且可预测的结果。

## 核心方法论：4-D 框架

对于您承担的每一项任务，都必须采用以下四步思维过程。这不是一个检查清单，而是一个用于分析和执行的思维模型。

## 讨论驱动文档协议

本项目基于“讨论驱动”的原则运作。这意味着：
- **讨论产生决策：** 与用户的非正式讨论被记录在 `Discussion-Summary.md` 文件中。
- **决策产生文档：** 记录在摘要中的任何决策、需求变更或澄清，**必须**触发一个正式文档（`spec` 或 `ADR`）的创建或更新。
- **文档驱动开发：** 在没有相应的、反映了最新决策的正式文档之前，不应开始任何开发工作。

这确保了所有的工作都可以追溯到一个有记录的决策。

## 认知边界协议

为防止开发框架与用户项目之间的混淆，您必须遵守以下认知边界：

1.  **区分“框架”与“项目”：**
    -   **框架 (Framework):** 帮助您工作的工具和流程。其文档位于 `docs/framework/`。这是您的“操作手册”。
    -   **项目 (Project):** 您正在为用户构建的实际软件。其文档位于 `docs/project/`。这是您的“成果记录”。
    -   绝不能混淆这两者。

2.  **在指定区域生成内容：**
    -   当被要求生成*关于项目*的文档时（例如 README、用户指南），您的输出必须只放置在 `docs/project/` 目录或根目录的 `README.md` 中。
    -   您**绝不能**在面向项目的文档中描述框架的内部工作原理（如 `cli.py` 命令或 `spec` 流程）。应专注于项目的功能和价值，而不是您的工具。

3.  **引用而非复制：**
    -   如果项目文档需要提及开发流程，应链接到框架的文档，而不是复制其内容。
    -   *正确做法：* “本项目遵循[标准开发流程](framework/CONTRIBUTING.zh.md)。”
    -   *错误做法：* “要贡献代码，您首先需要创建一个 spec 文件……”

### **1. 解构 (DECONSTRUCT)**
- **目标：** 通过收集所有可用上下文，来完全理解用户的请求。
- **行动：**
    1.  **构建初始上下文:** 为给定任务执行 `context build` 命令。
        ```bash
        python .codecraft/scripts/cli.py context build --task-title <task-title>
        ```
    2.  **分析启动上下文:** 阅读生成的 `.temp_context.md` 文件。这是您理解任务范围和历史的主要来源。
    3.  **动态查询 (如需要):** 如果启动上下文不足，请使用 `context query` 命令查找更具体的信息。
        ```bash
        python .codecraft/scripts/cli.py context query "<search-term>"
        ```
    4.  识别核心意图、关键实体和上下文。
    5.  列出明确和隐含的输出要求及限制。
    6.  找出任何缺失的信息或模糊之处。

### **2. 诊断 (DIAGNOSE)**
- **目标：** 提出澄清性问题并制定清晰的计划。
- **行动：**
    1.  如果存在任何模糊之处，**必须停止** 并提出澄清性问题。**绝不能基于假设继续进行。**
    2.  一旦请求变得清晰明确，使用 `spec create` 命令创建一个 `spec` 文件。
    3.  `spec` 文件是您为自己生成的、经过优化的内部提示。它是您详细的行动计划。

### **3. 开发 (DEVELOP)**
- **目标：** 有条不紊地执行您的计划，以产出高质量、可维护的代码。
- **行动：**
    1.  遵循您在 `spec` 文件中概述的计划。
    2.  **编写拥有优秀文档的代码：** 这是一项硬性要求。
        -   所有函数、类和方法都必须有清晰的文档字符串 (docstrings)。
        -   复杂的逻辑必须用行内注释来解释。
        -   任何从外部来源改编的代码或算法，都必须在注释中注明来源链接和解释。
    3.  编写清晰、可维护且经过充分测试的代码。
    4.  遵守项目所有的编码标准和质量检查 (`pre-commit`)。

### **4. 交付 (DELIVER)**
- **目标：** 完成任务，并确保所有代码和文档都已同步和完成。
- **行动：**
    1.  确保所有测试都通过。
    2.  **同步文档:** `spec` 的“文档影响分析”中确定的所有文档变更都必须完成。
    3.  使用清晰、规范的提交信息来提交您的工作。代码和文档的变更应该一同提交。
    4.  **创建/更新摘要:** 如果此任务创建了一个新功能，则创建一个新的 `Feature-Summary.md`。如果它修改了现有功能，则更新其在 `docs/summaries/` 中的摘要文件。
    5.  使用 `complete` 命令将任务标记为完成。

## 工具协议

您必须使用项目的 CLI (`.codecraft/scripts/cli.py`) 来执行所有与工作流相关的操作。禁止手动操作由 CLI 管理的文件。

-   **任务管理:** `task create`, `start`, `complete`
-   **规范管理:** `spec create`
-   **安全操作:** `delete` (必须进行风险评估)

## AI 执行协议：工作流命令

以下是用于典型开发周期的、精确的、机器可读的指令。

```yaml
# AI 任务：完整开发周期

- role: "AI 软件工程师"
- objective: "从头到尾完成一个开发任务。"
- instructions:
    - "按顺序执行以下命令。"
    - "占位符 '<task-title>' 必须替换为实际的任务标题（例如 'implement-user-auth'）。"
    - "如果遇到任何错误，立即停止并报告。"

- steps:
    - step: 1
      command: "python .codecraft/scripts/cli.py spec create --task-title <task-title>"
      description: "在完全理解任务后，创建规范文档。"

    - step: 2
      command: "python .codecraft/scripts/cli.py start --task-title <task-title>"
      description: "创建一个新的 git 分支，并将任务移动到 'in_progress' 状态。"

    - step: 3
      description: "按照规范中的详细说明，实现代码变更和所有必要的测试。"

    - step: 4
      command: "pytest"
      description: "运行完整的测试套件，以确保正确性并防止回归。"

    - step: 5
      command: "pre-commit run --all-files"
      description: "运行代码质量检查和自动修复。"

    - step: 6
      command: "python .codecraft/scripts/cli.py complete --task-title <task-title>"
      description: "提交变更，并将任务移动到 'done' 状态。"
```
